<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
  
<mapper namespace="com.sinosoft.platform.core.domain.mapper.UserServiceMapper">
    <select id="queryUserByUserID" parameterType="com.sinosoft.platform.core.domain.model.DefUser" resultType="com.sinosoft.platform.core.domain.model.DefUser">
        SELECT 
        <include refid="Base_Column_List" />
        FROM t_def_user  tdu
        WHERE tdu.id = #{id}  
    </select>  
    <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu May 12 09:48:03 CST 2016.
    -->
    tdu.id  id, tdu.usercode usercode,tdu.username username, tdu.password   password,
	tdu.company_Id  companyId, tdu.EMPOWER_TYPE empowerType,tdu.EMPOWER_Code  empowerCode,
	tdu.is_lock as isLock,tdu.user_state as userState 
  </sql>
    <!-- 根据用户编码查询 -->
    <select id="queryUserByUserCode" parameterType="com.sinosoft.platform.core.domain.model.DefUser" resultType="com.sinosoft.platform.core.domain.model.DefUser">  
        SELECT 
        <include refid="Base_Column_List" />
        FROM t_def_user  tdu
        WHERE tdu.usercode = #{usercode}
    </select>
    <select id="queryIdByUserCode" parameterType="com.sinosoft.platform.core.domain.model.DefUser"  resultType="java.math.BigDecimal">
    	select id
    	from t_def_user
    	where usercode=#{usercode}
    </select>
     <select id="queryUserByEmpowerCode" parameterType="com.sinosoft.platform.core.domain.model.DefUser" resultType="com.sinosoft.platform.core.domain.model.DefUser">  
        SELECT 
        <include refid="Base_Column_List" />
        FROM t_def_user  tdu
        WHERE tdu.Empower_code = #{empowerCode}
        <if test="empowerType!=null and empowerType!=''">
         and tdu.EMPOWER_TYPE = #{empowerType}
        </if> 
    </select>
    
    <select id="queryUserByUserName" parameterType="com.sinosoft.platform.core.domain.model.DefUser" resultType="com.sinosoft.platform.core.domain.model.DefUser">  
        SELECT 
        <include refid="Base_Column_List" />
        FROM t_def_user  tdu
        WHERE tdu.username = #{username}
        <if test="empowerType!=null and empowerType!=''">
         and tdu.EMPOWER_TYPE = #{empowerType}
        </if> 
    </select>
    
     <select id="queryRolesByUserCode" parameterType="com.sinosoft.platform.core.domain.model.DefUser" resultType="com.sinosoft.platform.core.domain.model.DefRole">  
        SELECT distinct r.ID ID,urr.user_code AS USERCODE, r.ROLECODE ROLECODE, r. ROLENAME
  			FROM T_DEF_ROLE r
  			INNER JOIN T_DEF_USER_ROLE_RELA urr ON r.id = urr.role_id
 			WHERE urr.user_code = #{usercode,jdbcType=VARCHAR}
 			ORDER BY USERCODE
    </select>
    <select id="queryRolesByUserId" parameterType="com.sinosoft.platform.core.domain.model.DefUser" resultType="com.sinosoft.platform.core.domain.model.DefRole">  
        SELECT DISTINCT urr.ROLE_ID ID,urr.user_code AS USERCODE, r.ROLECODE ROLECODE, r. ROLENAME
		  FROM T_DEF_USER u
		  INNER JOIN T_DEF_USER_ROLE_RELA urr ON urr.user_code = u.usercode
		  LEFT JOIN T_DEF_ROLE r ON r.id = urr.role_id
		  WHERE u.id = #{id} 
		  ORDER BY USERCODE
    </select>
    <select id="queryUserRolePrivilegeByUserId" parameterType="com.sinosoft.platform.core.domain.model.DefUser" resultType="java.lang.String">  
        select 1 from dual
    </select>
    
    
    <sql id="queryUserListInfoSQL">
		SELECT DISTINCT TDU.ID ID,
		          TDU.USERCODE USERCODE,
		          TDU.USERNAME USERNAME,
		          CD.CODE_NAME CODENAME,
		          TDU.USER_DESCRIBE USERDESCRIBE,
		          NVL(COM.COM_NAME,TDU.COMPANY_ID) COMPANYNAME,
		          TDU.COMPANY_ID COMPANYID,
		          TO_CHAR(TDU.START_DATE, 'YYYY-MM-DD') STARTDATE,
		          TO_CHAR(TDU.END_DATE, 'YYYY-MM-DD') ENDDATE,
		          TDU.CREATOR_CODE CREATORCODE,
		          TDU.EMAIL EMAIL,
		          TDU.EMPOWER_CODE EMPOWERCODE,
		          TDU.USER_STATE USERSTATE,
		          TDU.IS_LOCK ISLOCK
		  FROM T_DEF_USER TDU
		  LEFT JOIN T_DEF_USER_ROLE_RELA URR
		    ON URR.USER_CODE = TO_CHAR(TDU.USERCODE)
		  LEFT JOIN T_DEF_PLAT_COM COM
		    ON COM.COM_ID = TDU.COMPANY_ID
		  LEFT JOIN T_DEF_CODE_DICT CD
		    ON CD.CODE = TDU.USER_STATE WHERE　1 = 1
		   AND CD.CODE_TYPE = 'USER_STATUS'
			<if test="username!=null and username!=''">
			   	and tdu.username like '%' || #{username} || '%'
			</if>
			<if test="usercode!=null and usercode!=''">
			   	and tdu.usercode like '%' || #{usercode} || '%'
			</if>
			  <if test="startdate!=null and startdate!=''">
			   	and tdu.start_date <![CDATA[>=]]> TO_DATE(#{startdate},'YYYY-MM-DD')
			</if>
			<if test="enddate!=null and enddate!=''">
			   	and tdu.end_date <![CDATA[<=]]> TO_DATE(#{enddate},'YYYY-MM-DD')
			</if> 
			<!--<if test="companyId!=null and companyId!=''">
			   	and tdu.company_id like '%' || #{companyId} || '%'
			</if> -->
		ORDER BY usercode
	</sql>
    <!-- 用户信息列表查询（总记录数） -->
	<select id="queryUserListInfoCounts" resultType="java.lang.Integer" parameterType="java.util.Map" >
		select count(1) from 
		(
      	  	<include refid="queryUserListInfoSQL"/>
        )
	</select>
	
	<!-- 用户信息列表查询（分页查询） -->
	<select id="queryUserListInfoPages" resultType="java.util.Map" parameterType="java.util.Map" >
        select tAlias.* from
		(
	         select nAlias.*, rownum r_rownum from
	         (
		         <include refid="queryUserListInfoSQL"/>
		         
			 ) nAlias
		) tAlias where r_rownum >=#{queryStartIndex} and #{queryEndIndex} >= r_rownum
	</select>
	
	
	<!-- 测试报表的生成功能 -->
	<select id="exportExcel" resultType="java.util.Map" parameterType="java.util.Map" >
		 SELECT 
			 ID "batchNo",
			 usercode "reportTime",
			 company_id "reportCount",
			 empower_code "successCount",
			 username "failCount"
		from t_def_user 
	</select>
    
</mapper>  












